<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä¸šå¹³å° - ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ä¿æŒæ‚¨åŸæœ‰çš„æ ·å¼ä¸å˜ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        /* ... å…¶ä»–æ ·å¼ä¿æŒä¸å˜ ... */
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <h1>å·¥ä¸šå¹³å°</h1>
            </div>
            <div class="nav-links">
                <a href="/dashboard">ä»ªè¡¨ç›˜</a>
                <a href="#" id="logout">é€€å‡ºç™»å½•</a>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h2>ä»ªè¡¨ç›˜</h2>
                <div class="user-info">
                    <span id="userWelcome">æ¬¢è¿ï¼Œ</span>
                    <div class="dashboard-nav">
                        <button class="refresh-btn" id="refreshBtn">
                            <span class="refresh-icon">ğŸ”„</span>
                            åˆ·æ–°æ•°æ®
                        </button>
                        <a href="/inquiry-management" class="btn btn-secondary">è¯¢ä»·ç®¡ç†</a>
                        <a href="/user-profile" class="btn btn-secondary">ä¸ªäººèµ„æ–™</a>
                        <button id="logoutBtn" class="btn btn-secondary">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="stats-cards">
                    <div class="stat-card loading" id="totalProductsCard">
                        <h3>å•†å“æ€»æ•°</h3>
                        <p id="totalProducts">-</p>
                    </div>
                    <div class="stat-card loading" id="myInquiriesCard">
                        <h3>æˆ‘çš„è¯¢ä»·</h3>
                        <p id="myInquiries">-</p>
                    </div>
                    <div class="stat-card loading" id="pendingInquiriesCard">
                        <h3>å¾…å›å¤è¯¢ä»·</h3>
                        <p id="pendingInquiries">-</p>
                    </div>
                </div>

                <!-- å•†å“åˆ—è¡¨ -->
                <div class="products-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>å•†å“åˆ—è¡¨</h3>
                        <span class="product-count" id="productCount">åŠ è½½ä¸­...</span>
                    </div>
                    
                    <div id="productsList" class="products-grid">
                        <!-- å•†å“åŠ è½½éª¨æ¶å± -->
                        <div class="product-card loading">
                            <div class="loading-text">
                                <div class="loading"></div>
                                åŠ è½½å•†å“...
                            </div>
                        </div>
                        <div class="product-card loading">
                            <div class="loading-text">
                                <div class="loading"></div>
                                åŠ è½½å•†å“...
                            </div>
                        </div>
                        <div class="product-card loading">
                            <div class="loading-text">
                                <div class="loading"></div>
                                åŠ è½½å•†å“...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 å·¥ä¸šå¹³å°. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </footer>

    <script src="/js/app.js"></script>
    <script>
    let currentUser = null;
    let productsData = null;
    let inquiriesData = null;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
        document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.add('loading');
        });
        
        const productsList = document.getElementById('productsList');
        productsList.innerHTML = `
            <div class="product-card loading">
                <div class="loading-text">
                    <div class="loading"></div>
                    åŠ è½½å•†å“...
                </div>
            </div>
            <div class="product-card loading">
                <div class="loading-text">
                    <div class="loading"></div>
                    åŠ è½½å•†å“...
                </div>
            </div>
            <div class="product-card loading">
                <div class="loading-text">
                    <div class="loading"></div>
                    åŠ è½½å•†å“...
                </div>
            </div>
        `;
        
        document.getElementById('productCount').textContent = 'åŠ è½½ä¸­...';
    }

    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    function showError(message, retryCallback = null) {
        const productsList = document.getElementById('productsList');
        productsList.innerHTML = `
            <div class="error-state">
                <div class="icon">âš ï¸</div>
                <h3>åŠ è½½å¤±è´¥</h3>
                <p>${message}</p>
                ${retryCallback ? 
                    `<button class="btn btn-primary retry-button" id="retryBtn">é‡è¯•</button>` : 
                    ''
                }
            </div>
        `;
        
        if (retryCallback) {
            document.getElementById('retryBtn').addEventListener('click', retryCallback);
        }
        
        document.getElementById('totalProducts').textContent = '-';
        document.getElementById('myInquiries').textContent = '-';
        document.getElementById('pendingInquiries').textContent = '-';
        document.getElementById('productCount').textContent = 'åŠ è½½å¤±è´¥';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        const productsList = document.getElementById('productsList');
        productsList.innerHTML = `
            <div class="empty-state">
                <div class="icon">ğŸ“¦</div>
                <h3>æš‚æ— å•†å“</h3>
                <p>å½“å‰æ²¡æœ‰å¯æ˜¾ç¤ºçš„å•†å“æ•°æ®</p>
            </div>
        `;
        
        document.getElementById('productCount').textContent = '0 ä¸ªå•†å“';
    }

    // è®¾ç½®åˆ·æ–°æŒ‰é’®çŠ¶æ€
    function setRefreshButtonLoading(loading) {
        const refreshBtn = document.getElementById('refreshBtn');
        if (loading) {
            refreshBtn.classList.add('loading');
            refreshBtn.disabled = true;
        } else {
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
        }
    }

    // ç»‘å®šå•†å“è¯¦æƒ…ç‚¹å‡»äº‹ä»¶
    function bindProductDetailEvents() {
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç›‘å¬æ•´ä¸ªå•†å“åˆ—è¡¨çš„ç‚¹å‡»äº‹ä»¶
        const productsList = document.getElementById('productsList');
        productsList.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
            if (e.target.classList.contains('view-detail-btn') || 
                e.target.closest('.view-detail-btn')) {
                
                const button = e.target.classList.contains('view-detail-btn') 
                    ? e.target 
                    : e.target.closest('.view-detail-btn');
                
                const productId = button.getAttribute('data-product-id');
                console.log('ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼Œå•†å“ID:', productId);
                viewProductDetail(productId);
            }
        });
    }

    // æŸ¥çœ‹å•†å“è¯¦æƒ…
    function viewProductDetail(productId) {
        console.log('æŸ¥çœ‹å•†å“è¯¦æƒ…ï¼Œå•†å“ID:', productId);
        
        if (!productId || productId === 'undefined') {
            console.error('æ— æ•ˆçš„å•†å“ID:', productId);
            showTempMessage('å•†å“ä¿¡æ¯æ— æ•ˆ', 'error');
            return;
        }
        
        // è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
        window.location.href = `/product-detail?id=${productId}`;
    }

    // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
    function showTempMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            z-index: 10000;
            font-size: 14px;
            ${type === 'error' ? 'background: #e74c3c;' : ''}
            ${type === 'info' ? 'background: #3498db;' : ''}
            ${type === 'success' ? 'background: #27ae60;' : ''}
        `;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }

    // åŠ è½½æ•°æ®
    async function loadDashboardData() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
            return;
        }

        showLoading();
        setRefreshButtonLoading(true);

        try {
            const [productsResponse, inquiriesResponse] = await Promise.all([
                fetch('/api/products', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }),
                fetch('/api/inquiries/my-inquiries', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
            ]);

            if (!productsResponse.ok) {
                throw new Error(`å•†å“æ•°æ®åŠ è½½å¤±è´¥: ${productsResponse.status}`);
            }
            if (!inquiriesResponse.ok) {
                throw new Error(`è¯¢ä»·æ•°æ®åŠ è½½å¤±è´¥: ${inquiriesResponse.status}`);
            }

            const productsData = await productsResponse.json();
            const inquiriesData = await inquiriesResponse.json();

            // ç§»é™¤åŠ è½½çŠ¶æ€
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('loading');
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            if (productsData.status === 'success') {
                document.getElementById('totalProducts').textContent = productsData.results;
                document.getElementById('productCount').textContent = `${productsData.results} ä¸ªå•†å“`;
                
                // æ›´æ–°å•†å“åˆ—è¡¨
                if (productsData.data.products && productsData.data.products.length > 0) {
                    const productsList = document.getElementById('productsList');
                    productsList.innerHTML = productsData.data.products.map(product => `
                        <div class="product-card">
                            <h4>${product.name}</h4>
                            <p class="product-description">${product.description}</p>
                            <p class="price">Â¥${product.price} / ${product.unit}</p>
                            <p class="seller">ä¾›åº”å•†ï¼š${product.seller?.company || 'æœªçŸ¥ä¾›åº”å•†'}</p>
                            <button class="btn btn-primary view-detail-btn" data-product-id="${product._id}">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    `).join('');
                } else {
                    showEmptyState();
                }
            }

            // æ›´æ–°è¯¢ä»·ç»Ÿè®¡
            if (inquiriesData.status === 'success') {
                document.getElementById('myInquiries').textContent = inquiriesData.results;
                
                const pendingCount = inquiriesData.data.inquiries ? 
                    inquiriesData.data.inquiries.filter(inquiry => inquiry.status === 'pending').length : 0;
                document.getElementById('pendingInquiries').textContent = pendingCount;
            }

        } catch (error) {
            console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
            showError(error.message, loadDashboardData);
        } finally {
            setRefreshButtonLoading(false);
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        if (!token || !user) {
            window.location.href = '/';
            return;
        }
        
        currentUser = user;
        document.getElementById('userWelcome').textContent = `æ¬¢è¿ï¼Œ${user.username}ï¼ˆ${user.company}ï¼‰`;

        // ç»‘å®šå•†å“è¯¦æƒ…äº‹ä»¶
        bindProductDetailEvents();

        // åŠ è½½æ•°æ®
        loadDashboardData();

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶
        document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);

        // é€€å‡ºç™»å½•åŠŸèƒ½
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (window.app && window.app.logout) {
                window.app.logout();
            } else {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        });
    });
    </script>
</body>
</html>